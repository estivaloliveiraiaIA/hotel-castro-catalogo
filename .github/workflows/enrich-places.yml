name: Enrich places.json (Google Places)

on:
  # Manual run
  workflow_dispatch:
    inputs:
      limit:
        description: "Max places to enrich (default: 60)"
        required: false
        default: "60"
      mode:
        description: "missing = only missing fields | all = enrich all"
        required: false
        default: "missing"

  # 'Run by push' without requiring GitHub UI access.
  # Change .github/enrich.trigger to start an enrichment batch.
  push:
    branches: [main]
    paths:
      - ".github/enrich.trigger"

permissions:
  contents: write

concurrency:
  group: places-data
  cancel-in-progress: false

jobs:
  enrich:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: castro-park-discover/package-lock.json

      - name: Install
        working-directory: castro-park-discover
        run: npm ci

      - name: Enrich
        working-directory: castro-park-discover
        env:
          GOOGLE_PLACES_API_KEY: ${{ secrets.GOOGLE_PLACES_API_KEY }}
        run: |
          set -euo pipefail

          # Defaults for push-triggered runs
          LIMIT="100"
          MODE="missing"

          # If this run was triggered by the enrich-all trigger file, force MODE=all.
          if [ "${{ github.event_name }}" = "push" ] && git diff --name-only ${{ github.sha }}^ ${{ github.sha }} | grep -q "^\.github/enrich-all\.trigger$"; then
            MODE="all"
          fi

          # If manually dispatched, use provided inputs
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            LIMIT="${{ inputs.limit }}"
            MODE="${{ inputs.mode }}"
          fi

          echo "Running enrichment: limit=$LIMIT mode=$MODE"

          # Aumenta o sleep para reduzir OVER_QUERY_LIMIT
          SLEEP_MS="350"

          if [ "$MODE" = "all" ]; then
            npm run enrich:google -- --limit "$LIMIT" --sleep "$SLEEP_MS" --all
          else
            npm run enrich:google -- --limit "$LIMIT" --sleep "$SLEEP_MS"
          fi

      - name: Commit changes
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "Kira (OpenClaw)"
          git config user.email "kira-openclaw@users.noreply.github.com"
          git add castro-park-discover/public/data/places.json castro-park-discover/public/data/enrich-report.json
          git commit -m "data: enrich places via Google Places API"
          git pull --rebase
          git push
